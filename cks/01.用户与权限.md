# 用户与权限

## ServiceAccount

**创建 devops-tools 命名空间**
`
kubectl create namespace devops-tools
`

**在空间 devops-tools 中创建 sa api-service-account用户**
```bash
kubectl create serviceaccount api-service-account -n devops-tools

or

cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service-account
  namespace: webapps
EOF
```

**创建 app cluster role**

```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: api-cluster-role
  namespace: devops-tools
rules:
  - apiGroups:
        - ""
        - apps
        - autoscaling
        - batch
        - extensions
        - policy
        - rbac.authorization.k8s.io
    resources:
      - pods
      - componentstatuses
      - configmaps
      - daemonsets
      - deployments
      - events
      - endpoints
      - horizontalpodautoscalers
      - ingress
      - jobs
      - limitranges
      - namespaces
      - nodes
      - pods
      - persistentvolumes
      - persistentvolumeclaims
      - resourcequotas
      - replicasets
      - replicationcontrollers
      - serviceaccounts
      - services
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
EOF
```

**将 role 跟相关的用户绑定在一起**
```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: api-cluster-role-binding
subjects:
- namespace: devops-tools 
  kind: ServiceAccount
  name: api-service-account 
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: api-cluster-role 
EOF
```

## 验证用户的权限

**验证用户是否有通过kubectl访问相关资源的权限**
```bash
kubectl auth can-i get po --as=system:serviceaccount:devops-tools:api-service-account

kubectl auth can-i get deployments --as=system:serviceaccount:devops-tools:api-service-account
```

**验证SA是否有访问API的权限**
```bash
sa_secrets=$(kubectl get serviceaccount api-service-account  -o=jsonpath='{.secrets[0].name}' -n devops-tools)
sa_token=$(kubectl get secrets  $sa_secrets  -o=jsonpath='{.data.token}' -n devops-tools | base64 -d)

endpoint_host=https://$(kubectl get endpoints | grep kubernetes | awk '{print $2}')
curl -k  $endpoint_host/api/v1/namespaces -H "Authorization: Bearer $sa_token"

// 获取所有的资源
kubectl api-resources
```

**验证 Kubernetes Role 的权限**

- 创建 SA 是 api-service-account 的 pod
```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Pod
metadata:
  name: debug
  namespace: devops-tools
spec:
  containers:
  - image: theohbrothers/docker-kubectl:latest
    name: kubectl
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo hello; sleep 10;done"]
  serviceAccountName: api-service-account
EOF
```

- 进入 pod 然后执行 kubectl 获取相关资源
  
```bash
kubectl exec -it po/debug -n devops-tools /bin/sh

---- kubectl get po --all-namespaces
```

*VS*

- 创建 SA 是 default 的 pod
```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Pod
metadata:
  name: debug
  namespace: devops-tools
spec:
  containers:
  - image: theohbrothers/docker-kubectl:latest
    name: kubectl
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo hello; sleep 10;done"]
  serviceAccountName: api-service-account
EOF
```

- 进入 pod 然后执行 kubectl 获取相关资源
  
```bash
kubectl exec -it po/debug -n devops-tools /bin/sh

---- kubectl get po --all-namespaces
```

*VS*

`
kubectl auth can-i get po --all-namespaces --as=system:serviceaccount:devops-tools:default
`


**参考文档**
- [How to Create kubernetes Role for Service Account](https://devopscube.com/create-kubernetes-role/)
- [How To Create Kubernetes Service Account For API Access](https://devopscube.com/kubernetes-api-access-service-account/)
- [docker-kubectl image](https://hub.docker.com/r/theohbrothers/docker-kubectl)